# M5Paper ICS Alarm with MIDI

M5Paper の e-Ink ディスプレイと Unit Synth を使ったカレンダーアラームシステムです。  
ICS 形式のカレンダーを定期取得し、予定に埋め込んだマーカーに従って MIDI 音源でアラームを鳴らします。  
ntfy.sh によるスマホへのプッシュ通知にも対応しています。

**BUILD_VERSION: 020**

---

## 目次

1. [ハードウェア要件](#ハードウェア要件)
2. [ソフトウェア要件](#ソフトウェア要件)
3. [SD カードの準備](#sd-カードの準備)
4. [設定ファイル (config.json)](#設定ファイル-configjson)
5. [アラームマーカーの書式](#アラームマーカーの書式)
6. [画面と操作方法](#画面と操作方法)
7. [設定メニュー](#設定メニュー)
8. [ntfy.sh プッシュ通知](#ntfysh-プッシュ通知)
9. [技術詳細](#技術詳細)
10. [トラブルシューティング](#トラブルシューティング)

---

## ハードウェア要件

| 部品 | 型番 | 備考 |
|------|------|------|
| 本体 | M5Paper v1.1 | 540×960 e-Ink、タッチスクリーン |
| MIDI 音源 | Unit Synth (SAM2695) | M5Stack 公式 MIDI シンセモジュール |
| microSD カード | 任意 | フォント・設定・MIDI ファイル格納用 |

### 接続ポート

Unit Synth は以下のいずれかのポートに接続します（`config.json` の `port_select` で選択）:

| port_select | ポート | TX ピン |
|:-----------:|--------|:-------:|
| 0 | PORT A | GPIO 25 |
| **1** | **PORT B** | **GPIO 26**（デフォルト） |
| 2 | PORT C | GPIO 18 |

### 側面スイッチ

M5Paper 側面の 3 つの物理スイッチを使用します:

| スイッチ | GPIO | 一覧画面 | 設定画面 | 詳細画面 |
|:--------:|:----:|----------|----------|----------|
| L (上) | 37 | 前の予定を選択 | 前の設定項目 | スクロール上 |
| R (下) | 39 | 次の予定を選択 | 次の設定項目 | スクロール下 |
| P (中央) | 38 | 設定画面を開く | 決定 / 実行 | 一覧に戻る |

---

## ソフトウェア要件

Arduino IDE で以下をインストールしてください。

### ボードマネージャ

- **M5Stack** by M5Stack（バージョン **2.1.4**）
  - Tools → Board → Boards Manager → "M5Stack" で検索

### ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|:---------:|------|
| M5EPD | 0.1.5 | e-Ink ディスプレイ制御 |
| ArduinoJson | 6.21.x 以降 | 設定ファイル (JSON) の読み書き |
| M5Unit-Synth | 1.0.x 以降 | MIDI ボーレート定数 (`UNIT_SYNTH_BAUD`) の定義 |

ESP32 コアに含まれるライブラリ（WiFi, WiFiClientSecure, HTTPClient, SD, time, base64）は追加インストール不要です。

### 追加ファイル

- **SimpleMIDIPlayer.h** — 同梱のカスタム MIDI プレイヤー（SysEx 対応、標準 SD ライブラリ互換）

---

## SD カードの準備

```
SD カード/
├── config.json          ← 設定ファイル（下記参照）
├── fonts/
│   └── ipaexg.ttf       ← IPAex ゴシックフォント（日本語表示用）
├── midi/
│   └── alarm.mid        ← デフォルトアラーム音 MIDI ファイル
└── midi-dl/             ← URL からダウンロードした MIDI（自動作成）
```

- `/midi/` — 手動で配置する MIDI ファイル用（`.mid` / `.MID` / `.midi` / `.MIDI`）
- `/midi-dl/` — URL からダウンロードした MIDI のキャッシュ用（**自動作成**、手動作成不要）
- フォントがない場合はデフォルトフォント（英数字のみ）で動作します

---

## 設定ファイル (config.json)

SD カードのルートに `config.json` を配置します。存在しない場合はデフォルト値で起動します。  
設定画面の「Save & Exit」でも保存されます。

### 基本設定

```jsonc
{
  // WiFi 接続情報
  "wifi_ssid": "your_wifi_ssid",      // WiFi アクセスポイント名
  "wifi_pass": "your_wifi_password",   // WiFi パスワード

  // ICS カレンダー
  "ics_url": "https://example.com/calendar.ics",  // ICS カレンダーの URL (https 対応)
  "ics_user": "",   // Basic 認証ユーザー名（不要なら空文字）
  "ics_pass": "",   // Basic 認証パスワード（不要なら空文字）
```

### MIDI 再生設定

```jsonc
  // MIDI 音源
  "midi_file": "/midi/alarm.mid",  // デフォルト MIDI ファイルの SD カード内パス
  "midi_url": "",                  // MIDI ダウンロード用ベース URL（空なら無効）
                                   // 例: "https://example.com/midi" → !>song.mid! で
                                   // "https://example.com/midi/song.mid" をダウンロード

  // MIDI 通信
  "midi_baud": 31250,   // MIDI ボーレート（31250 / 31520 / 38400 から選択）
  "port_select": 1,     // Unit Synth 接続ポート（0=PORT A, 1=PORT B, 2=PORT C）
```

### アラーム動作設定

```jsonc
  // アラーム
  "alarm_offset": 10,    // デフォルトのアラーム分前（!!/! でマーカー指定なしの場合）
  "play_duration": 0,    // デフォルト鳴動時間(秒)。0 = 1曲を最後まで再生
  "play_repeat": 1,      // デフォルト繰り返し回数（1〜5）
```

### 表示設定

```jsonc
  // 表示
  "time_24h": true,      // true = 24 時間表示 (14:30)、false = 12 時間表示 (2:30PM)
  "text_wrap": false,    // true = 長いタイトルを折り返し(2行)、false = 切り詰め+".."
```

### 通信・更新設定

```jsonc
  // ICS 更新
  "ics_poll_min": 30,    // ICS の定期取得間隔（分）。選択肢: 5, 10, 15, 30, 60
                         // 最小 5 分（メモリフラグメンテーション防止のため）

  // プッシュ通知
  "ntfy_topic": "",      // ntfy.sh のトピック名（空なら通知無効）
                         // 例: "my-m5paper-alarm"
```

### メモリ管理設定（上級者向け）

```jsonc
  // メモリ管理（通常は変更不要）
  "max_events": 99,       // スケジュールバッファの最大件数（10〜99）
                          // MAX_EVENTS(100)のうち1枠をテスト用に確保
  "max_desc_bytes": 500,  // DESCRIPTION の最大保持バイト数（100以上）
                          // アラームマーカーのパースは切り詰め前に実行されるため
                          // 検出精度には影響しない
  "min_free_heap": 80     // ヒープ残量下限(KB)。これ以下でICSイベント読み込み停止
                          // 最小 40KB
}
```

### 設定値の制約

| パラメータ | 制約 |
|-----------|------|
| `ics_poll_min` | 最小 5 分（5 未満は自動的に 5 に修正） |
| `max_events` | 10〜99（範囲外は自動補正） |
| `max_desc_bytes` | 最小 100 |
| `min_free_heap` | 最小 40 KB |

---

## アラームマーカーの書式

Google カレンダーなどで予定を作成し、タイトル（SUMMARY）か説明（DESCRIPTION）にマーカーを記述します。

### 検索優先順位

1. **SUMMARY の `!...!` マーカー**（タイトル末尾の単独 `!` も有効）
2. **DESCRIPTION の `!...!` マーカー**

SUMMARY で見つかった場合、DESCRIPTION は検索しません。

### 基本書式

| 記述例 | 意味 |
|--------|------|
| `会議!` | タイトル末尾の `!` 1 つでデフォルトアラーム（SUMMARY のみ） |
| `会議!!` | 同上（`!!` = 空のマーカー = デフォルト設定） |
| `会議!-15!` | 15 分前にアラーム |
| `会議!+5!` | 5 分後にアラーム（リマインダー用） |

**タイトル末尾の単独 `!`** は SUMMARY でのみ有効です。DESCRIPTION 内の単独 `!` はアラームとして認識されません。

### オプション記号一覧

`!` と `!` の間に以下のオプションを自由に組み合わせて記述できます:

| 記号 | 意味 | 例 | 詳細 |
|------|------|-----|------|
| `-数字` | 指定分**前**にアラーム | `!-30!` = 30 分前 | 0〜1440（24時間）の範囲 |
| `+数字` | 指定分**後**にアラーム | `!+10!` = 10 分後 | リマインダー・フォローアップ用 |
| `<ファイル名` | SD カードの MIDI を使用 | `!<chime.mid!` | `/midi/chime.mid` を再生 |
| `>ファイル名` | URL から MIDI をダウンロード | `!>song.mid!` | `midi_url` + `/song.mid` をDLして再生 |
| `@秒数` | 再生時間を秒で指定 | `!@15!` = 15 秒再生 | 途中でも時間が来たら停止 |
| `@` | 1 曲を最後まで再生 | `!@!` | 時間制限なし |
| `*回数` | 繰り返し回数を指定 | `!*3!` = 3 回繰り返し | 鳴動時間と併用可 |

### 記号の意味の覚え方

| 記号 | イメージ |
|------|----------|
| `-` | マイナス = 過去方向 = 分前 |
| `+` | プラス = 未来方向 = 分後 |
| `<` | リダイレクト入力 = SD カードからファイルを読み込む |
| `>` | ダウンロード = URL からファイルを取得する |
| `@` | 時間 = 秒数指定 |
| `*` | 掛け算 = 回数指定 |

### 組み合わせ例

```
重要会議!-10<important.mid@20*2!
→ 10分前に /midi/important.mid を 20秒 × 2回再生

リマインダー!+5!
→ 5分後にデフォルト MIDI でアラーム

朝礼!-5@!
→ 5分前に 1曲を最後まで再生

定例!-3>special.mid*3!
→ 3分前に midi_url/special.mid をダウンロードして3回再生
```

### 鳴動パラメータの優先順位

マーカーで指定されなかったパラメータは `config.json` の設定値が使われます:

| パラメータ | マーカー指定あり | マーカー指定なし |
|-----------|:---:|:---:|
| アラーム時刻 | `-分` / `+分` | `alarm_offset` の値（分前） |
| MIDI ファイル | `<file` / `>file` | `midi_file` のパス |
| 鳴動時間 | `@秒` / `@` | `play_duration` の値 |
| 繰り返し回数 | `*回数` | `play_repeat` の値 |

### 全角文字サポート

スマホなどで入力した**全角の記号**（`！` `＞` `＜` `＋` `－` `＠` `＊` など）は自動的に半角に変換されます。  
`会議！！` や `会議！ー１０！` のような入力でも正しく認識されます。

### 複数マーカー

1 つのテキスト中に複数の `!...!` マーカーがある場合、**絶対値が最大のオフセット**が採用されます。  
ファイル名は最後に見つかった指定が使われます。

---

## 画面と操作方法

### 画面遷移図

```
一覧画面 (UI_LIST)
├── タップ → 詳細画面 (UI_DETAIL)
│   └── タップ → 一覧に戻る
├── P ボタン → 設定画面 (UI_SETTINGS)
│   ├── テキスト項目 → キーボード画面 (UI_KEYBOARD)
│   ├── MIDI File → ファイル選択 (UI_MIDI_SELECT)
│   ├── MIDI Baud → ボーレート選択 (UI_BAUD_SELECT)
│   ├── Port → ポート選択 (UI_PORT_SELECT)
│   └── Save & Exit → 一覧に戻る
└── アラーム発火 → 再生画面 (UI_PLAYING)
    └── タップ → 一覧に戻る
```

### 1. 予定一覧画面

起動後のメイン画面です。

**ヘッダー部分（上部）:**
- 左: 現在の日付と時刻
- 右: WiFi 接続状態（`WiFi:OK` / `WiFi:NG`）

**一覧表示:**
- **日付ヘッダー**: 濃いグレー背景 + 白太字で「── 2/5 (水) ──」のように表示。日付が変わるたびに挿入
- **予定行**: 時刻（または `[終日]`）+ アラームマーク + タイトル
  - **♪**（黒背景白文字の反転表示）: 未発火のアラーム付き予定
  - **\***: 発火済みのアラーム付き予定
  - **アンダーライン**: 現在時刻以降で最も近い非終日予定（＝次の予定）
- テキスト折り返し設定が ON の場合、長いタイトルは 2 行で表示
- テキスト折り返し設定が OFF の場合、末尾に `..` を付けて切り詰め

**フッター部分:**
- 左: `N/M件`（選択位置 / 全件数）
- 右: `次AL:HH:MM`（次のアラーム時刻）

**画面下部ボタン:**

| ボタン | 動作 |
|--------|------|
| `<前日` | 表示を前日の先頭にスクロール |
| `翌日>` | 表示を翌日の先頭にスクロール |
| `今日` | 今日の先頭にスクロール |
| `詳細` | 選択中の予定の詳細画面を表示 |

**スイッチ操作:**

| スイッチ | 動作 |
|:--------:|------|
| L | 前の予定を選択（先頭で押すと末尾に移動） |
| R | 次の予定を選択（末尾で押すと先頭に移動） |
| P | 設定画面を開く |

### 2. 詳細画面

選択した予定の詳細情報を表示します。

**表示内容:**
1. **日付と時刻**（または `[終日]`）
2. **アラーム情報**: 時刻、オフセット（「10分前」「5分後」「時刻通り」）、発火済みマーク `[済]`
3. **追加情報行**: MIDI ファイル指定（♪SD:/♪URL:）、鳴動時間（秒 or 1曲）、繰り返し回数
4. **タイトル**（複数行対応）
5. **説明文**（スクロール対応、複数行折り返し）

**操作:**

| 操作 | 動作 |
|------|------|
| タップ | 一覧画面に戻る |
| L スイッチ | 説明文を上にスクロール |
| R スイッチ | 説明文を下にスクロール |
| P スイッチ | 一覧画面に戻る |

### 3. 再生画面

アラーム発火時、またはサウンドテスト時に表示されます。

**表示内容:**
- 大文字で「ALARM!」（または「SOUND TEST」）
- 予定のタイトル（2 行まで）
- 予定の開始時刻
- 鳴動情報（「15秒 x2回」「1曲 x1回」など）
- 説明文（複数行、画面下部まで）
- 「タップで停止」

**操作:**
- **タップ**: 再生を即座に停止し、一覧画面に戻る

**鳴動の仕組み:**
- `play_duration_ms > 0` の場合: 指定時間が経過したら繰り返し途中でも停止
- `play_duration_ms == 0`（1曲モード）の場合: 曲の終了を待ち、繰り返し回数分リピート
- MIDI 停止時は全チャンネルの All Sound Off + All Notes Off + GM System On リセットを送信

### 4. キーボード画面

テキスト入力が必要な設定項目で使用します。

**画面構成:**
- 上半分: 編集対象のフィールド名、現在の入力値（複数行対応）、文字数表示
- 下半分: QWERTY キーボード（タッチ入力）

**機能ボタン:**

| ボタン | 動作 |
|--------|------|
| BS | 末尾 1 文字削除 |
| CAP | 大文字/小文字切り替え（反転表示で状態表示） |
| !@# / ABC | 記号キーボード / 通常キーボード切り替え |
| CLR | 全文字消去 |
| SP | スペース挿入 |
| OK | 入力を確定して設定画面に戻る |
| ESC | キャンセルして設定画面に戻る |

---

## 設定メニュー

P スイッチで一覧画面から設定画面に入ります。  
**先頭の項目がグレー背景で強調表示**されます。L/R で移動、P で決定です。

### 設定項目一覧（全 20 項目）

| # | 項目名 | 操作方法 | 説明 |
|:-:|--------|----------|------|
| 1 | WiFi SSID | キーボード | WiFi アクセスポイント名 |
| 2 | WiFi Pass | キーボード | WiFi パスワード（表示は `****`） |
| 3 | ICS URL | キーボード | ICS カレンダーの URL |
| 4 | ICS User | キーボード | Basic 認証ユーザー名 |
| 5 | ICS Pass | キーボード | Basic 認証パスワード（表示は `****`） |
| 6 | MIDI File | ファイル選択画面 | `/midi/` 内の MIDI ファイルをリスト選択 |
| 7 | MIDI URL | キーボード | MIDI ダウンロード用ベース URL |
| 8 | MIDI Baud | ボーレート選択 | 31250 / 31520 / 38400 から選択 |
| 9 | Port | ポート選択 | PORT A(G25) / PORT B(G26) / PORT C(G18) |
| 10 | Alarm Offset | P で循環 | 0, 5, 10, 15, ..., 60 分（5 分刻み） |
| 11 | Time Format | P でトグル | 24h ↔ 12h |
| 12 | Text Display | P でトグル | 折り返し ↔ 切り詰め |
| 13 | ICS Poll | P で循環 | 5, 10, 15, 30, 60 分 |
| 14 | Play Duration | P で循環 | 1曲, 5秒, 10秒, 15秒, 20秒 |
| 15 | Play Repeat | P で循環 | 1, 2, 3, 4, 5 回 |
| 16 | Notify Topic | キーボード | ntfy.sh トピック名 |
| 17 | Notify Test | P で実行 | 通知テスト送信 |
| 18 | ICS Update | P で実行 | ICS を即時再取得 |
| 19 | Sound Test | P で実行 | デフォルト MIDI でサウンドテスト |
| 20 | Save & Exit | P で実行 | 設定を SD に保存して一覧に戻る |

**ナビゲーションボタン（画面最下部）:**

| ボタン | 動作 |
|--------|------|
| `<<先頭` | カーソルを最初の項目に移動 |
| `末尾>>` | カーソルを最後の項目に移動 |
| `戻る` | 保存せず一覧画面に戻る |

### 補助画面

- **MIDI ファイル選択画面**: `/midi/` フォルダ内の `.mid` ファイルをリスト表示。L/R で移動、P で選択、タップで戻る
- **ボーレート選択画面**: 31250 / 31520 / 38400 の 3 択。選択するとその場で `Serial2` のボーレートも変更
- **ポート選択画面**: PORT A / B / C の 3 択。選択するとその場で `Serial2` を再初期化

---

## ntfy.sh プッシュ通知

アラーム発火時にスマホへプッシュ通知を送信できます。

### 設定手順

1. スマホに [ntfy アプリ](https://ntfy.sh/) をインストール
2. アプリでトピックを購読（例: `my-m5paper-alarm`）
3. `config.json` に `"ntfy_topic": "my-m5paper-alarm"` を設定

### 通知内容

- **タイトル**: `M5Paper Alarm`
- **本文**: `HH:MM 予定のタイトル`
- **優先度**: high
- **タグ**: alarm_clock（⏰ アイコン）

### テスト

設定画面の「Notify Test」を実行すると、`M5Paper Test` というタイトルでテスト通知が送信されます。  
トピック未設定や WiFi 未接続の場合はエラーメッセージが画面に表示されます。

---

## 技術詳細

### ICS 取得・解析

- **プロトコル**: HTTPS（証明書検証はスキップ）
- **認証**: Basic 認証対応（`ics_user` / `ics_pass`）
- **タイムアウト**: 接続 10 秒、読み取り 15 秒
- **ICS 行展開**: RFC 5545 に従い、改行+スペース/タブによる継続行を展開
- **日時形式**: `YYYYMMDDTHHMMSS`（ローカル）、`YYYYMMDDTHHMMSSZ`（UTC→JST変換）、`YYYYMMDD`（終日）
- **表示範囲**: 現在時刻の 24 時間前 〜 1 年後の予定

### ICS 定期更新とバックオフ

- 通常は `ics_poll_min` の間隔で自動取得
- 取得失敗時は `(ics_poll_min × (1 + 連続失敗回数))` の間隔に延長（最大 6 倍）
- WiFi 切断時は自動再接続を試行
- **アラーム再生中は ICS 取得をスキップ**（HTTP 通信が MIDI 再生を妨げるため）

### アラーム発火メカニズム

1. `checkAlarms()` がループ内で毎サイクル実行（ただし再生中・設定画面中はスキップ）
2. `alarm_time <= now` かつ `triggered == false` のイベントを検出
3. ntfy.sh 通知送信 → MIDI 再生開始 → 再生画面表示
4. 再生完了または手動停止で `triggered = true` に設定

**アラーム猶予期間（ALARM_GRACE_SEC = 600 秒）:**  
ICS 再取得時にイベントが再構築されますが、`alarm_time` が `now - 600秒` 以内の場合は `triggered = false`（未発火）として扱います。これにより ICS 再取得とアラーム発火のタイミング競合を防ぎます。

### MIDI 再生

- **プレイヤー**: SimpleMIDIPlayer（SysEx メッセージ対応）
- **通信**: `Serial2`（TX のみ、ハーフデュプレックス）
- **停止処理**: 全 16 チャンネルの All Sound Off (CC#120) + All Notes Off (CC#123) → GM System On リセット

**MIDI ダウンロード (`>ファイル名` 指定時):**
1. `midi_url` が空の場合はダウンロードせずデフォルト MIDI を使用
2. `/midi-dl/` フォルダが存在しない場合は**自動作成**
3. `/midi-dl/ファイル名` が既に存在する場合は**ダウンロードをスキップ**（キャッシュ）
4. `midi_url` + `/` + `ファイル名` を HTTP GET でダウンロード
5. ダウンロード失敗時はデフォルト MIDI (`config.midi_file`) を使用

### 時刻同期

- **NTP サーバー**: `pool.ntp.org`、`time.google.com`
- **タイムゾーン**: JST (UTC+9)、固定
- 起動時に最大 10 秒間 NTP 同期を待機

### 自動表示更新

- 3 分間操作がなく、一覧画面表示中の場合、毎分表示位置をチェック
- 日付が変わった場合など、表示開始位置が変化した時のみ画面を再描画

### メモリ管理

ESP32 のヒープメモリは限られているため、以下の対策が実装されています:
- `max_events` でイベント数を制限（デフォルト 99）
- `max_desc_bytes` で DESCRIPTION のバイト数を制限（UTF-8 安全な切り詰め）
- `min_free_heap` でヒープ残量が下限以下になるとイベント読み込みを停止
- ICS 生データは unfold 後即座に解放
- 4 バイト UTF-8 文字（絵文字など）は表示から除外

---

## トラブルシューティング

### WiFi に接続できない

- `config.json` の `wifi_ssid` / `wifi_pass` を確認
- 設定画面（P ボタン）からも変更可能
- 接続タイムアウトは 15 秒

### 予定が表示されない

- `ics_url` が正しいか確認
- Basic 認証が必要な場合は `ics_user` / `ics_pass` を設定
- 設定画面の「ICS Update」で手動再取得を試す
- シリアルモニタで HTTP ステータスコードを確認

### アラームが鳴らない

- タイトルまたは説明に `!` マーカーが正しく記述されているか確認
- 全角 `！` も認識されますが、間にスペースがないか確認
- `alarm_offset` のデフォルト値が意図通りか確認
- 再生中画面（UI_PLAYING）中は ICS 取得とアラームチェックが停止するため、同時発火はしません

### MIDI が再生されない

- SD カードの `/midi/` フォルダに `.mid` ファイルがあるか確認
- 設定画面の「Sound Test」でテスト再生を試す
- `port_select` が正しいポートか確認
- `midi_baud` が Unit Synth の設定と一致しているか確認（通常 31250）
- Unit Synth の電源とケーブルを確認

### 画面が更新されない

- e-Ink は残像が残ることがあります。画面遷移時に GC16 モードで全面更新されます
- 3 分以上操作がない場合、一覧画面は毎分自動チェックされますが、表示位置が変わらなければ再描画しません

### ヒープメモリ不足

- シリアルモニタで `heap:` の値を確認
- `max_events` を小さくする（例: 50）
- `max_desc_bytes` を小さくする（例: 200）
- `ics_poll_min` を大きくする（メモリフラグメンテーション軽減）
